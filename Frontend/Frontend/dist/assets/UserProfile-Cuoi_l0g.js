import{u as $e,c as H,r as u,w as he,o as Ee,b as i,h as t,l as a,m,e as s,K as Me,E as f,s as Fe,d as p,x as n,j as Le,z as v,F as ae,A as oe,y as j,G as Ae,D as De,L as Ie,M as Re,N as qe}from"./index-QOScO0--.js";import{d as ze,u as Te,b as Be}from"./items-Cme2rVli.js";import{g as Se,f as se}from"./index-oGPApeZQ.js";import{_ as Ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ye={class:"profile-layout"},He={key:0,class:"not-login-tip"},je={key:1},Ge={class:"profile-navbar"},Ke={class:"user-info-header"},Oe={class:"avatar-section"},We={key:0},Je={class:"user-details"},Qe={class:"user-actions"},Xe={class:"posts-header"},Ze={key:0,class:"empty-posts"},et={key:1,class:"posts-grid"},tt={class:"post-image"},lt=["src"],at={key:1,class:"no-image"},ot={class:"post-content"},st={class:"post-header"},nt={class:"post-title"},rt={class:"post-desc"},dt={class:"post-location"},ut={class:"post-time"},it={class:"post-actions"},mt={class:"posts-header"},pt={key:0,class:"empty-posts"},vt={key:1,class:"posts-grid"},ct={class:"post-image"},ft=["src"],gt={key:1,class:"no-image"},_t={class:"post-content"},yt={class:"post-header"},wt={class:"post-title"},kt={class:"post-desc"},bt={class:"post-location"},Vt={class:"post-time"},Pt={class:"post-actions"},Ct={class:"avatar-upload-dialog"},xt={class:"avatar-preview-large"},Ut=["src"],$t=["src"],ht={key:2,class:"no-avatar"},Et={__name:"UserProfile",setup(Mt){const c=$e(),U=Fe(),ne=H(()=>c.isLogin),w=H(()=>c.userInfo||{name:"未登录",studentId:"",email:"",phone:"",wechat:"",avatar:null}),$=H(()=>Se(w.value.avatar)),V=u([]),P=u([]),I=u("published"),k=u(!1),C=u(!1),h=u(!1),x=u(!1),E=u(""),M=u(null),R=u(!1),_=u({oldPassword:"",newPassword:"",confirmPassword:""}),G=u(),q=u(!1),F=u({password:""}),K=u(),z=u(!1),d=u({name:"",category:"",status:"",description:"",location:"",contact:"",date:null}),O=u(),T=u(!1),L=u(null),re={oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码至少6位",trigger:"blur"}],confirmPassword:[{required:!0,validator:ie,trigger:"blur"}]},de={password:[{required:!0,message:"请输入密码确认注销",trigger:"blur"}]},ue={name:[{required:!0,message:"请输入物品名称",trigger:"blur"},{min:1,max:50,message:"物品名称长度在1到50个字符",trigger:"blur"}],category:[{required:!0,message:"请选择物品类型",trigger:"change"}],status:[{required:!0,message:"请选择物品状态",trigger:"change"}],description:[{required:!0,message:"请输入详细描述",trigger:"blur"},{min:10,max:500,message:"描述长度在10到500个字符",trigger:"blur"}],location:[{required:!0,message:"请输入地点描述",trigger:"blur"}],contact:[{required:!0,message:"请输入联系方式",trigger:"blur"}],date:[{required:!0,message:"请选择时间",trigger:"change"}]};function ie(o,e,r){e===""?r(new Error("请再次输入密码")):e!==_.value.newPassword?r(new Error("两次输入密码不一致")):r()}async function B(){try{const o=await Me(c.token);V.value=o.data,console.log("获取到的我的帖子数据:",V.value)}catch(o){console.error("获取我的帖子失败:",o),f.error("获取我的帖子失败")}}async function me(){try{const o=await Be(c.token);P.value=o.data}catch(o){console.error("获取我的认领失败:",o),f.error("获取我的认领失败")}}function W(o){const e=o.type.startsWith("image/"),r=o.size/1024/1024<2;return e?(r||f.error("头像大小不能超过 2MB！"),!1):(f.error("头像必须是图片格式！"),!1)}function pe(o){if(W(o.raw))return;M.value=o.raw;const e=new FileReader;e.onload=r=>{E.value=r.target.result},e.readAsDataURL(o.raw)}async function ve(){if(!M.value){f.warning("请先选择头像");return}R.value=!0;try{const o=await Ie(M.value,c.token);f.success("头像更新成功"),await c.refreshUserInfo(),window.dispatchEvent(new CustomEvent("avatar-updated")),k.value=!1,E.value="",M.value=null}catch(o){f.error(o.response?.data?.msg||"头像更新失败")}finally{R.value=!1}}async function ce(){G.value.validate(async o=>{if(o){q.value=!0;try{await Re(_.value,c.token),f.success("密码修改成功"),C.value=!1,_.value={oldPassword:"",newPassword:"",confirmPassword:""}}catch(e){f.error(e.response?.data?.msg||"密码修改失败")}finally{q.value=!1}}})}async function fe(){K.value.validate(async o=>{if(o){z.value=!0;try{await qe(F.value.password,c.token),f.success("账户注销成功"),c.logout(),U.push("/")}catch(e){f.error(e.response?.data?.msg||"账户注销失败")}finally{z.value=!1}}})}function J(o){U.push(`/?selected=${o.id}`)}async function ge(o){try{console.log("删除帖子 - post对象:",o),console.log("删除帖子 - post.id:",o.id),await De.confirm(`确定要删除帖子"${o.name}"吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ze(o.id,c.token),f.success("帖子删除成功"),await B()}catch(e){console.error("删除帖子错误:",e),e!=="cancel"&&f.error(e.response?.data?.msg||"删除失败")}}function _e(o){L.value=o,d.value={name:o.name,category:o.category,status:o.status,description:o.desc||o.description,location:o.locationText||o.location,contact:o.contact,date:o.time?new Date(o.time):null},x.value=!0}async function ye(){O.value.validate(async o=>{if(o){T.value=!0;try{console.log("编辑帖子 - currentEditPost:",L.value),console.log("编辑帖子 - currentEditPost.id:",L.value?.id);const e={name:d.value.name,category:d.value.category,status:d.value.status,description:d.value.description,location:d.value.location,contact:d.value.contact,date:d.value.date.toISOString()};console.log("编辑帖子 - 更新数据:",e),await Te(L.value.id,e,c.token),f.success("帖子更新成功"),x.value=!1,await B()}catch(e){console.error("编辑帖子错误:",e),f.error(e.response?.data?.msg||"更新失败")}finally{T.value=!1}}})}function Q(o){return{id:"证件",electronics:"电子产品",book:"书籍文具",clothes:"衣物用品",key:"钥匙卡片",other:"其他"}[o]||"其他"}function X(){U.push("/")}function Z(){U.push("/").then(()=>{window.dispatchEvent(new CustomEvent("show-publish-dialog"))})}return he(I,o=>{o==="claimed"&&P.value.length===0&&me()}),Ee(async()=>{if(c.token)try{await c.checkLoginStatus()&&c.isLogin?await B():c.logout()}catch(o){console.error("验证登录状态失败:",o),c.logout()}}),(o,e)=>{const r=m("el-button"),S=m("el-card"),we=m("el-avatar"),ee=m("el-empty"),A=m("el-tag"),te=m("el-tab-pane"),ke=m("el-tabs"),be=m("el-icon"),Ve=m("el-upload"),D=m("el-dialog"),y=m("el-input"),g=m("el-form-item"),N=m("el-form"),Pe=m("el-alert"),b=m("el-option"),Ce=m("el-select"),le=m("el-radio"),xe=m("el-radio-group"),Ue=m("el-date-picker");return p(),i("div",Ye,[ne.value?(p(),i("div",je,[s("div",Ge,[t(r,{type:"primary",icon:"el-icon-arrow-left",onClick:X,round:""},{default:a(()=>e[27]||(e[27]=[n("返回主页")])),_:1,__:[27]}),e[28]||(e[28]=s("span",{class:"profile-title"},"个人中心",-1))]),t(S,{class:"user-info-card"},{default:a(()=>[s("div",Ke,[s("div",Oe,[t(we,{size:80,src:$.value,onClick:e[0]||(e[0]=l=>k.value=!0)},{default:a(()=>[$.value?Le("",!0):(p(),i("span",We,v(w.value.name?.charAt(0)||"用"),1))]),_:1},8,["src"]),t(r,{text:"",type:"primary",onClick:e[1]||(e[1]=l=>k.value=!0),class:"change-avatar-btn"},{default:a(()=>e[29]||(e[29]=[n(" 更换头像 ")])),_:1,__:[29]})]),s("div",Je,[s("h2",null,v(w.value.name),1),s("p",null,[e[30]||(e[30]=s("strong",null,"学号：",-1)),n(v(w.value.studentId),1)]),s("p",null,[e[31]||(e[31]=s("strong",null,"邮箱：",-1)),n(v(w.value.email),1)]),s("p",null,[e[32]||(e[32]=s("strong",null,"电话：",-1)),n(v(w.value.phone||"未设置"),1)]),s("p",null,[e[33]||(e[33]=s("strong",null,"微信：",-1)),n(v(w.value.wechat||"未设置"),1)])]),s("div",Qe,[t(r,{type:"primary",onClick:e[2]||(e[2]=l=>C.value=!0)},{default:a(()=>e[34]||(e[34]=[n("修改密码")])),_:1,__:[34]}),t(r,{type:"warning",onClick:e[3]||(e[3]=l=>h.value=!0)},{default:a(()=>e[35]||(e[35]=[n("注销账户")])),_:1,__:[35]})])])]),_:1}),t(S,{class:"profile-card"},{default:a(()=>[t(ke,{modelValue:I.value,"onUpdate:modelValue":e[4]||(e[4]=l=>I.value=l)},{default:a(()=>[t(te,{label:"我的发布",name:"published"},{default:a(()=>[s("div",Xe,[s("h3",null,"我的发布 ("+v(V.value.length)+")",1),t(r,{type:"primary",onClick:Z},{default:a(()=>e[36]||(e[36]=[n("发布新帖")])),_:1,__:[36]})]),V.value.length===0?(p(),i("div",Ze,[t(ee,{description:"还没有发布任何帖子"},{default:a(()=>[t(r,{type:"primary",onClick:Z},{default:a(()=>e[37]||(e[37]=[n("发布第一个帖子")])),_:1,__:[37]})]),_:1})])):(p(),i("div",et,[(p(!0),i(ae,null,oe(V.value,l=>(p(),i("div",{key:l.id,class:"post-card"},[s("div",tt,[l.images&&l.images.length>0?(p(),i("img",{key:0,src:l.images[0],alt:"帖子图片"},null,8,lt)):(p(),i("div",at,"无图片"))]),s("div",ot,[s("div",st,[t(A,{type:l.status==="lost"?"danger":"success"},{default:a(()=>[n(v(l.status==="lost"?"丢失":"拾取"),1)]),_:2},1032,["type"]),t(A,{effect:"plain"},{default:a(()=>[n(v(Q(l.category)),1)]),_:2},1024)]),s("h4",nt,v(l.name),1),s("p",rt,v(l.desc),1),s("p",dt,"📍 "+v(l.locationText),1),s("p",ut,"🕒 "+v(j(se)(l.time)),1),s("div",it,[t(r,{size:"small",onClick:Y=>J(l)},{default:a(()=>e[38]||(e[38]=[n("查看")])),_:2,__:[38]},1032,["onClick"]),t(r,{size:"small",type:"warning",onClick:Y=>_e(l)},{default:a(()=>e[39]||(e[39]=[n("编辑")])),_:2,__:[39]},1032,["onClick"]),t(r,{size:"small",type:"danger",onClick:Y=>ge(l)},{default:a(()=>e[40]||(e[40]=[n("删除")])),_:2,__:[40]},1032,["onClick"])])])]))),128))]))]),_:1}),t(te,{label:"我的认领",name:"claimed"},{default:a(()=>[s("div",mt,[s("h3",null,"我的认领 ("+v(P.value.length)+")",1)]),P.value.length===0?(p(),i("div",pt,[t(ee,{description:"还没有认领任何物品"})])):(p(),i("div",vt,[(p(!0),i(ae,null,oe(P.value,l=>(p(),i("div",{key:l.id,class:"post-card"},[s("div",ct,[l.images&&l.images.length>0?(p(),i("img",{key:0,src:l.images[0],alt:"帖子图片"},null,8,ft)):(p(),i("div",gt,"无图片"))]),s("div",_t,[s("div",yt,[t(A,{type:"success"},{default:a(()=>e[41]||(e[41]=[n("已认领")])),_:1,__:[41]}),t(A,{effect:"plain"},{default:a(()=>[n(v(Q(l.category)),1)]),_:2},1024)]),s("h4",wt,v(l.name),1),s("p",kt,v(l.desc),1),s("p",bt,"📍 "+v(l.locationText),1),s("p",Vt,"🕒 认领时间："+v(j(se)(l.claimedAt)),1),s("div",Pt,[t(r,{size:"small",onClick:Y=>J(l)},{default:a(()=>e[42]||(e[42]=[n("查看")])),_:2,__:[42]},1032,["onClick"])])])]))),128))]))]),_:1})]),_:1},8,["modelValue"])]),_:1})])):(p(),i("div",He,[t(S,{style:{"max-width":"400px",margin:"60px auto","text-align":"center"}},{default:a(()=>[e[25]||(e[25]=s("div",{style:{"font-size":"20px",color:"#ff9800","margin-bottom":"12px"}},"未登录",-1)),e[26]||(e[26]=s("div",{style:{"margin-bottom":"16px"}},"请先登录后再访问个人中心",-1)),t(r,{type:"primary",onClick:X},{default:a(()=>e[24]||(e[24]=[n("返回主页")])),_:1,__:[24]})]),_:1,__:[25,26]})])),t(D,{modelValue:k.value,"onUpdate:modelValue":e[6]||(e[6]=l=>k.value=l),title:"更换头像",width:"400px"},{footer:a(()=>[t(r,{onClick:e[5]||(e[5]=l=>k.value=!1)},{default:a(()=>e[45]||(e[45]=[n("取消")])),_:1,__:[45]}),t(r,{type:"primary",onClick:ve,loading:R.value},{default:a(()=>e[46]||(e[46]=[n("保存")])),_:1,__:[46]},8,["loading"])]),default:a(()=>[s("div",Ct,[t(Ve,{"show-file-list":!1,"before-upload":W,"on-change":pe,accept:"image/*","auto-upload":!1},{default:a(()=>[s("div",xt,[E.value?(p(),i("img",{key:0,src:E.value,alt:"头像预览"},null,8,Ut)):$.value?(p(),i("img",{key:1,src:$.value,alt:"当前头像"},null,8,$t)):(p(),i("div",ht,[t(be,{size:"60"},{default:a(()=>[t(j(Ae))]),_:1}),e[43]||(e[43]=s("div",null,"点击选择头像",-1))]))])]),_:1}),e[44]||(e[44]=s("p",{class:"upload-tip"},"支持jpg、png格式，大小不超过2MB",-1))])]),_:1},8,["modelValue"]),t(D,{modelValue:C.value,"onUpdate:modelValue":e[11]||(e[11]=l=>C.value=l),title:"修改密码",width:"400px"},{footer:a(()=>[t(r,{onClick:e[10]||(e[10]=l=>C.value=!1)},{default:a(()=>e[47]||(e[47]=[n("取消")])),_:1,__:[47]}),t(r,{type:"primary",onClick:ce,loading:q.value},{default:a(()=>e[48]||(e[48]=[n("确认修改")])),_:1,__:[48]},8,["loading"])]),default:a(()=>[t(N,{model:_.value,rules:re,ref_key:"passwordFormRef",ref:G,"label-width":"80px"},{default:a(()=>[t(g,{label:"旧密码",prop:"oldPassword"},{default:a(()=>[t(y,{modelValue:_.value.oldPassword,"onUpdate:modelValue":e[7]||(e[7]=l=>_.value.oldPassword=l),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),t(g,{label:"新密码",prop:"newPassword"},{default:a(()=>[t(y,{modelValue:_.value.newPassword,"onUpdate:modelValue":e[8]||(e[8]=l=>_.value.newPassword=l),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),t(g,{label:"确认密码",prop:"confirmPassword"},{default:a(()=>[t(y,{modelValue:_.value.confirmPassword,"onUpdate:modelValue":e[9]||(e[9]=l=>_.value.confirmPassword=l),type:"password","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(D,{modelValue:h.value,"onUpdate:modelValue":e[14]||(e[14]=l=>h.value=l),title:"注销账户",width:"400px"},{footer:a(()=>[t(r,{onClick:e[13]||(e[13]=l=>h.value=!1)},{default:a(()=>e[50]||(e[50]=[n("取消")])),_:1,__:[50]}),t(r,{type:"danger",onClick:fe,loading:z.value},{default:a(()=>e[51]||(e[51]=[n("确认注销")])),_:1,__:[51]},8,["loading"])]),default:a(()=>[t(Pe,{title:"警告",type:"warning",closable:!1,style:{"margin-bottom":"20px"}},{default:a(()=>e[49]||(e[49]=[n(" 注销账户将永久删除您的所有数据，包括发布的帖子、评论等，此操作不可恢复！ ")])),_:1,__:[49]}),t(N,{model:F.value,rules:de,ref_key:"deleteFormRef",ref:K,"label-width":"80px"},{default:a(()=>[t(g,{label:"确认密码",prop:"password"},{default:a(()=>[t(y,{modelValue:F.value.password,"onUpdate:modelValue":e[12]||(e[12]=l=>F.value.password=l),type:"password","show-password":"",placeholder:"请输入密码确认注销"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(D,{modelValue:x.value,"onUpdate:modelValue":e[23]||(e[23]=l=>x.value=l),title:"编辑帖子",width:"600px"},{footer:a(()=>[t(r,{onClick:e[22]||(e[22]=l=>x.value=!1)},{default:a(()=>e[54]||(e[54]=[n("取消")])),_:1,__:[54]}),t(r,{type:"primary",onClick:ye,loading:T.value},{default:a(()=>e[55]||(e[55]=[n("保存修改")])),_:1,__:[55]},8,["loading"])]),default:a(()=>[t(N,{model:d.value,rules:ue,ref_key:"editFormRef",ref:O,"label-width":"80px"},{default:a(()=>[t(g,{label:"物品名称",prop:"name"},{default:a(()=>[t(y,{modelValue:d.value.name,"onUpdate:modelValue":e[15]||(e[15]=l=>d.value.name=l),placeholder:"请输入物品名称"},null,8,["modelValue"])]),_:1}),t(g,{label:"物品类型",prop:"category"},{default:a(()=>[t(Ce,{modelValue:d.value.category,"onUpdate:modelValue":e[16]||(e[16]=l=>d.value.category=l),placeholder:"请选择物品类型"},{default:a(()=>[t(b,{label:"证件",value:"id"}),t(b,{label:"电子产品",value:"electronics"}),t(b,{label:"书籍文具",value:"book"}),t(b,{label:"衣物用品",value:"clothes"}),t(b,{label:"钥匙卡片",value:"key"}),t(b,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"物品状态",prop:"status"},{default:a(()=>[t(xe,{modelValue:d.value.status,"onUpdate:modelValue":e[17]||(e[17]=l=>d.value.status=l)},{default:a(()=>[t(le,{value:"lost"},{default:a(()=>e[52]||(e[52]=[n("丢失")])),_:1,__:[52]}),t(le,{value:"found"},{default:a(()=>e[53]||(e[53]=[n("拾取")])),_:1,__:[53]})]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"详细描述",prop:"description"},{default:a(()=>[t(y,{modelValue:d.value.description,"onUpdate:modelValue":e[18]||(e[18]=l=>d.value.description=l),type:"textarea",rows:"4",placeholder:"请详细描述物品特征，包括颜色、品牌、外观等信息..."},null,8,["modelValue"])]),_:1}),t(g,{label:"地点描述",prop:"location"},{default:a(()=>[t(y,{modelValue:d.value.location,"onUpdate:modelValue":e[19]||(e[19]=l=>d.value.location=l),placeholder:"请描述丢失或拾取的具体地点"},null,8,["modelValue"])]),_:1}),t(g,{label:"联系方式",prop:"contact"},{default:a(()=>[t(y,{modelValue:d.value.contact,"onUpdate:modelValue":e[20]||(e[20]=l=>d.value.contact=l),placeholder:"请输入手机号或微信号"},null,8,["modelValue"])]),_:1}),t(g,{label:"时间",prop:"date"},{default:a(()=>[t(Ue,{modelValue:d.value.date,"onUpdate:modelValue":e[21]||(e[21]=l=>d.value.date=l),type:"datetime",placeholder:"选择丢失或拾取时间",format:"YYYY-MM-DD HH:mm"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},It=Ne(Et,[["__scopeId","data-v-92c2ac04"]]);export{It as default};
