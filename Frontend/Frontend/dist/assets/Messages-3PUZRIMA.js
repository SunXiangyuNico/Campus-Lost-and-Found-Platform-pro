import{O,b as l,e as a,h as d,l as c,m as _,u as P,r as f,B as S,o as Q,P as W,E as w,Q as j,D as G,s as J,R as X,d as n,x as p,g as Y,F as N,A as E,n as I,j as b,z as m,i as z,k as Z,p as $}from"./index-QOScO0--.js";import{g as ee,b as se,c as te,s as ae,d as oe,m as F,h as ne}from"./messages-WA174WDX.js";import{f as ie}from"./index-oGPApeZQ.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const re={name:"Messages",components:{Loading:O},setup(){P();const H=J(),o=()=>{H.push("/")},K=f("notifications"),s=f([]),R=f([]),y=f([]),C=f([]),h=f(null),M=f(!1),k=f(""),v=f(null),g=S({notifications:!1,claims:!1,conversations:!1}),u=S({notifications:0,claims:0,conversations:0}),x=async()=>{g.notifications=!0;try{const t=await ee();s.value=Array.isArray(t)?t:t.data||[],u.notifications=s.value.filter(r=>!r.isRead).length}catch(t){console.error("加载系统通知失败:",t),w.error("加载系统通知失败")}finally{g.notifications=!1}},T=async()=>{g.claims=!0;try{const t=await se();R.value=Array.isArray(t)?t:t.data||[],u.claims=R.value.filter(r=>!r.isRead).length}catch(t){console.error("加载认领申请失败:",t),w.error("加载认领申请失败")}finally{g.claims=!1}},A=async()=>{g.conversations=!0;try{const t=await te(),r=Array.isArray(t)?t:t.data||[];y.value=r.map(i=>({otherUserId:i.withUser?.id,otherUserName:i.withUser?.name||i.withUser?.username,otherUserAvatar:i.withUser?.avatar,lastMessage:i.lastMessage,lastMessageTime:i.timestamp,unreadCount:i.unreadCount||0,item:i.item})),u.conversations=y.value.reduce((i,L)=>i+(L.unreadCount||0),0)}catch(t){console.error("加载私信列表失败:",t),w.error("加载私信列表失败")}finally{g.conversations=!1}},B=async t=>{if(!t.isRead)try{await F([t.id],"system_notification"),t.isRead=!0,u.notifications--}catch(r){console.error("标记通知已读失败:",r)}},D=async(t,r)=>{try{await G.confirm(`确定要${r==="approved"?"批准":"拒绝"}这个认领申请吗？`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ne(t,r),w.success(`已${r==="approved"?"批准":"拒绝"}认领申请`);const i=R.value.find(L=>L.id===t);i&&(i.status=r,i.isRead=!0,u.claims=Math.max(0,u.claims-1)),r==="approved"&&window.dispatchEvent(new CustomEvent("claim-status-updated"))}catch(i){i!=="cancel"&&(console.error("处理认领申请失败:",i),w.error("处理认领申请失败"))}},e=async t=>{h.value=t,M.value=!0;try{const r=await oe(t.otherUserId);if(C.value=r.messages||[],t.unreadCount>0){const i=t.unreadCount;await F([],"private_message",t.otherUserId),t.unreadCount=0,u.conversations=Math.max(0,u.conversations-i)}await j(),v.value&&(v.value.scrollTop=v.value.scrollHeight)}catch(r){console.error("加载对话消息失败:",r),w.error("加载对话消息失败")}},U=async()=>{if(k.value.trim()){try{const t=await ae(h.value.otherUserId,k.value.trim());C.value.push(t),k.value="",await j(),v.value&&(v.value.scrollTop=v.value.scrollHeight);const r=y.value.find(i=>i.otherUserId===h.value.otherUserId);if(r){r.lastMessage=t.content,r.lastMessageTime=t.timestamp;const i=y.value.indexOf(r);i>0&&(y.value.splice(i,1),y.value.unshift(r))}}catch(t){console.error("发送消息失败:",t),w.error("发送消息失败")}window.dispatchEvent(new CustomEvent("message-updated"))}},V=()=>{x(),T(),A()};let q=null;return Q(()=>{x(),T(),A(),q=setInterval(V,3e4),window.addEventListener("message-updated",V)}),W(()=>{q&&clearInterval(q),window.removeEventListener("message-updated",V)}),{activeTab:K,notifications:s,claimRequests:R,conversations:y,currentMessages:C,currentConversation:h,showConversationDialog:M,newMessage:k,messagesContainer:v,loading:g,unreadCounts:u,formatTime:ie,goToHome:o,markNotificationAsRead:B,handleClaimResponse:D,openConversation:e,sendMessage:U,refreshAllMessages:V}}},de={class:"messages-container"},ce={class:"messages-header"},me={class:"header-right"},ue={class:"tab-label"},_e={class:"tab-content"},ve={key:0,class:"loading-container","element-loading-text":"加载中..."},ge={key:1,class:"empty-state"},he={key:2,class:"notification-list"},fe=["onClick"],pe={class:"notification-content"},ye={class:"notification-text"},Ce={class:"notification-time"},ke={key:0,class:"unread-dot"},we={class:"tab-label"},be={class:"tab-content"},Me={key:0,class:"loading-container"},Re={key:1,class:"empty-state"},Ue={key:2,class:"claim-list"},xe={class:"claim-content"},Te={class:"claim-header"},Ae={class:"applicant-name"},Ve={class:"claim-time"},Ne={key:0,class:"claim-item-info"},Ee={class:"item-name"},Ie={class:"claim-text"},Be={key:1,class:"claim-actions"},De={key:2,class:"claim-status"},qe={key:0,class:"unread-dot"},Le={class:"tab-label"},ze={class:"tab-content"},He={key:0,class:"loading-container"},Ke={key:1,class:"empty-state"},Se={key:2,class:"conversation-list"},je=["onClick"],Fe={class:"conversation-avatar"},Oe={class:"conversation-content"},Pe={class:"conversation-header"},Qe={class:"other-user-name"},We={class:"last-time"},Ge={class:"last-message"},Je={key:0,class:"unread-badge"},Xe={class:"conversation-messages",ref:"messagesContainer"},Ye={class:"message-content"},Ze={class:"message-text"},$e={class:"message-time"},es={class:"message-input-area"},ss={class:"input-actions"};function ts(H,o,K,s,R,y){const C=_("el-button"),h=_("el-badge"),M=_("el-empty"),k=_("el-tab-pane"),v=_("Loading"),g=_("el-icon"),u=_("el-tag"),x=_("el-avatar"),T=_("el-tabs"),A=_("el-input"),B=_("el-dialog"),D=X("loading");return n(),l("div",de,[a("div",ce,[o[4]||(o[4]=a("div",{class:"header-left"},[a("h1",null,"我的消息")],-1)),a("div",me,[d(C,{type:"primary",icon:"house",onClick:s.goToHome},{default:c(()=>o[3]||(o[3]=[p(" 返回首页 ")])),_:1,__:[3]},8,["onClick"])])]),d(T,{modelValue:s.activeTab,"onUpdate:modelValue":o[0]||(o[0]=e=>s.activeTab=e),class:"messages-tabs"},{default:c(()=>[d(k,{name:"notifications"},{label:c(()=>[a("span",ue,[o[5]||(o[5]=p(" 系统通知 ")),s.unreadCounts.notifications>0?(n(),z(h,{key:0,value:s.unreadCounts.notifications,class:"tab-badge"},null,8,["value"])):b("",!0)])]),default:c(()=>[a("div",_e,[s.loading.notifications?Y((n(),l("div",ve,o[6]||(o[6]=[a("div",{style:{height:"100px"}},null,-1)]))),[[D,s.loading.notifications]]):s.notifications.length===0?(n(),l("div",ge,[d(M,{description:"暂无系统通知"})])):(n(),l("div",he,[(n(!0),l(N,null,E(s.notifications,e=>(n(),l("div",{key:e.id,class:I(["notification-item",{unread:!e.isRead}]),onClick:U=>s.markNotificationAsRead(e)},[a("div",pe,[a("div",ye,m(e.content),1),a("div",Ce,m(s.formatTime(e.timestamp)),1)]),e.isRead?b("",!0):(n(),l("div",ke))],10,fe))),128))]))])]),_:1}),d(k,{name:"claims"},{label:c(()=>[a("span",we,[o[7]||(o[7]=p(" 待处理帖子 ")),s.unreadCounts.claims>0?(n(),z(h,{key:0,value:s.unreadCounts.claims,class:"tab-badge"},null,8,["value"])):b("",!0)])]),default:c(()=>[a("div",be,[s.loading.claims?(n(),l("div",Me,[d(g,{class:"is-loading"},{default:c(()=>[d(v)]),_:1}),o[8]||(o[8]=a("span",null,"加载中...",-1))])):s.claimRequests.length===0?(n(),l("div",Re,[d(M,{description:"暂无认领申请"})])):(n(),l("div",Ue,[(n(!0),l(N,null,E(s.claimRequests,e=>(n(),l("div",{key:e.id,class:I(["claim-item",{unread:!e.isRead}])},[a("div",xe,[a("div",Te,[a("span",Ae,m(e.requester?.name||"用户"),1),a("span",Ve,m(s.formatTime(e.timestamp)),1)]),e.item?(n(),l("div",Ne,[a("span",Ee,"物品："+m(e.item.name),1)])):b("",!0),a("div",Ie,m(e.content),1),e.status==="pending"?(n(),l("div",Be,[d(C,{type:"success",size:"small",onClick:U=>s.handleClaimResponse(e.id,"approved")},{default:c(()=>o[9]||(o[9]=[p(" 批准 ")])),_:2,__:[9]},1032,["onClick"]),d(C,{type:"danger",size:"small",onClick:U=>s.handleClaimResponse(e.id,"rejected")},{default:c(()=>o[10]||(o[10]=[p(" 拒绝 ")])),_:2,__:[10]},1032,["onClick"])])):(n(),l("div",De,[d(u,{type:e.status==="approved"?"success":"danger"},{default:c(()=>[p(m(e.status==="approved"?"已批准":"已拒绝"),1)]),_:2},1032,["type"])]))]),e.isRead?b("",!0):(n(),l("div",qe))],2))),128))]))])]),_:1}),d(k,{name:"conversations"},{label:c(()=>[a("span",Le,[o[11]||(o[11]=p(" 私信列表 ")),s.unreadCounts.conversations>0?(n(),z(h,{key:0,value:s.unreadCounts.conversations,class:"tab-badge"},null,8,["value"])):b("",!0)])]),default:c(()=>[a("div",ze,[s.loading.conversations?(n(),l("div",He,[d(g,{class:"is-loading"},{default:c(()=>[d(v)]),_:1}),o[12]||(o[12]=a("span",null,"加载中...",-1))])):s.conversations.length===0?(n(),l("div",Ke,[d(M,{description:"暂无私信"})])):(n(),l("div",Se,[(n(!0),l(N,null,E(s.conversations,e=>(n(),l("div",{key:e.otherUserId,class:I(["conversation-item",{unread:e.unreadCount>0}]),onClick:U=>s.openConversation(e)},[a("div",Fe,[d(x,{src:e.otherUserAvatar},{default:c(()=>[p(m(e.otherUserName?.charAt(0)||"用"),1)]),_:2},1032,["src"])]),a("div",Oe,[a("div",Pe,[a("span",Qe,m(e.otherUserName||"未知用户"),1),a("span",We,m(s.formatTime(e.lastMessageTime)),1)]),a("div",Ge,m(e.lastMessage),1)]),e.unreadCount>0?(n(),l("div",Je,[d(h,{value:e.unreadCount},null,8,["value"])])):b("",!0)],10,je))),128))]))])]),_:1})]),_:1},8,["modelValue"]),d(B,{modelValue:s.showConversationDialog,"onUpdate:modelValue":o[2]||(o[2]=e=>s.showConversationDialog=e),title:`与 ${s.currentConversation?.otherUserName||"用户"} 的对话`,width:"600px",class:"conversation-dialog"},{default:c(()=>[a("div",Xe,[(n(!0),l(N,null,E(s.currentMessages,e=>(n(),l("div",{key:e.id,class:I(["message-item",{"own-message":e.sender==="me"}])},[a("div",Ye,[a("div",Ze,m(e.content),1),a("div",$e,m(s.formatTime(e.timestamp)),1)])],2))),128))],512),a("div",es,[d(A,{modelValue:s.newMessage,"onUpdate:modelValue":o[1]||(o[1]=e=>s.newMessage=e),type:"textarea",rows:3,placeholder:"输入消息...",onKeydown:Z($(s.sendMessage,["ctrl"]),["enter"])},null,8,["modelValue","onKeydown"]),a("div",ss,[o[14]||(o[14]=a("span",{class:"input-tip"},"Ctrl + Enter 发送",-1)),d(C,{type:"primary",onClick:s.sendMessage,disabled:!s.newMessage.trim()},{default:c(()=>o[13]||(o[13]=[p(" 发送 ")])),_:1,__:[13]},8,["onClick","disabled"])])])]),_:1},8,["modelValue","title"])])}const ls=le(re,[["render",ts],["__scopeId","data-v-b3ac5b31"]]);export{ls as default};
